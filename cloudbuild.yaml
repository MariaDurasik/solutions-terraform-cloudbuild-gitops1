# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
steps:
  # Docker Build
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t',
            'gcr.io/$PROJECT_ID/myimage:$SHORT_SHA', '.' ]
  # Docker push to Google Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'push',  'gcr.io/$PROJECT_ID/myimage:$SHORT_SHA' ]
  #Terraform init
  - name: 'hashicorp/terraform:0.13.5'
    args: [ 'init' ]
  #Terraform plaan
  - name: 'hashicorp/terraform:0.13.5'
    args: [ 'plan' ]
  #Terraform apply
  - name: 'hashicorp/terraform:0.13.5'
    args: [ 'apply', '-auto-approve' ]
  - name: 'gcr.io/cloud-foundation-cicd/$_DOCKER_IMAGE_DEVELOPER_TOOLS:$_DOCKER_TAG_VERSION_DEVELOPER_TOOLS'
  args: [ '/bin/bash', '-c', 'source /usr/local/bin/task_helper_functions.sh && prepare_environment' ]
  env:
    - 'TF_VAR_org_id=$_ORG_ID'
    - 'TF_VAR_folder_id=$_FOLDER_ID'
    - 'TF_VAR_billing_account=$_BILLING_ACCOUNT'
  - name: 'gcr.io/cloud-foundation-cicd/$_DOCKER_IMAGE_DEVELOPER_TOOLS:$_DOCKER_TAG_VERSION_DEVELOPER_TOOLS'
  args: [ '/bin/bash', '-c', 'source /usr/local/bin/task_helper_functions.sh && prepare_environment' ]
  env:
    - 'TF_VAR_org_id=$_ORG_ID'
    - 'TF_VAR_folder_id=$_FOLDER_ID'
    - 'TF_VAR_billing_account=$_BILLING_ACCOUNT'
    - name: 'gcr.io/cloud-foundation-cicd/$_DOCKER_IMAGE_DEVELOPER_TOOLS:$_DOCKER_TAG_VERSION_DEVELOPER_TOOLS'
  args: [ '/bin/bash', '-c', 'source /usr/local/bin/task_helper_functions.sh && kitchen_do create' ]
    - name: 'gcr.io/cloud-foundation-cicd/$_DOCKER_IMAGE_DEVELOPER_TOOLS:$_DOCKER_TAG_VERSION_DEVELOPER_TOOLS'
  args: [ '/bin/bash', '-c', 'source /usr/local/bin/task_helper_functions.sh && kitchen_do converge' ]
    - name: 'gcr.io/cloud-foundation-cicd/$_DOCKER_IMAGE_DEVELOPER_TOOLS:$_DOCKER_TAG_VERSION_DEVELOPER_TOOLS'
  args: [ '/bin/bash', '-c', 'source /usr/local/bin/task_helper_functions.sh && kitchen_do verify' ]
    - name: 'gcr.io/cloud-foundation-cicd/$_DOCKER_IMAGE_DEVELOPER_TOOLS:$_DOCKER_TAG_VERSION_DEVELOPER_TOOLS'
  args: [ '/bin/bash', '-c', 'source /usr/local/bin/task_helper_functions.sh && kitchen_do destroy' ]
tags:
  - 'ci'
  - 'integration'
substitutions:
  _DOCKER_IMAGE_DEVELOPER_TOOLS: 'cft/developer-tools'
  _DOCKER_TAG_VERSION_DEVELOPER_TOOLS: '0.13'
